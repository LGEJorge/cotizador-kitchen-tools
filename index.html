<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cotizador Kitchen Tools</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f8f9fa;
    }
    h1 {
      text-align: center;
      color: #0d3a5e;
    }
    form {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    label {
      font-weight: bold;
    }
    .section {
      margin-top: 30px;
    }
    .toggle-button {
      background-color: #0d3a5e;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    .toggle-button:hover {
      background-color: #0a2e4b;
    }
    .hidden {
      display: none;
    }
    button[type="submit"] {
      width: 100%;
      padding: 12px;
      background-color: #0d3a5e;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button[type="submit"]:hover {
      background-color: #0a2e4b;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .move-btn {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>Generador de Cotizaciones</h1>
  <form id="cotizarForm">
    <label for="cliente">Nombre del Cliente:</label>
    <input type="text" id="cliente" name="cliente" required>

    <label for="vencimiento">Fecha de Vencimiento:</label>
    <input type="date" id="vencimiento" name="vencimiento" required>
    <br><br>
    <label for="codigos">Códigos de Producto (separados por coma):</label>
    <input type="text" id="codigos" name="codigos" required>

    <button type="button" class="toggle-button" onclick="toggleParametros()">Mostrar/Ocultar Parámetros de Medios de Pago</button>
    <div class="section hidden" id="parametros">
      <h2>Parámetros de Medios de Pago</h2>
      <table id="tabla-medios">
        <thead>
          <tr>
            <th>Medio</th>
            <th>% (positivo = recargo, negativo = descuento)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br>
      <label for="marketing">Gasto de Marketing (%):</label>
      <input type="number" id="marketing" name="marketing" value="0">
      <br><br>
      <button type="button" class="toggle-button" onclick="agregarFila()">+ Agregar Medio de Pago</button>
      <br>
      <button type="button" class="toggle-button" onclick="guardarParametrosServidor()">💾 Guardar Parámetros</button>
    </div>

    <p id="estadoCotizacion" style="text-align:center; font-size:15px; font-weight:bold; color:#0d3a5e;"></p>
    <button type="submit" id="btnCotizar">Cotizar</button>
  </form>

<script>
function toggleParametros() {
  const div = document.getElementById("parametros");
  div.classList.toggle("hidden");
}

function eliminarFila(boton) {
  boton.parentElement.parentElement.remove();
}

function moverFila(boton, direccion) {
  const fila = boton.closest("tr");
  const tbody = fila.parentElement;
  if (direccion === "arriba" && fila.previousElementSibling) {
    tbody.insertBefore(fila, fila.previousElementSibling);
  } else if (direccion === "abajo" && fila.nextElementSibling) {
    tbody.insertBefore(fila.nextElementSibling, fila);
  }
}

function agregarFila(label = '', coef = '') {
  const contenedor = document.querySelector("#tabla-medios tbody");
  const fila = document.createElement("tr");
  fila.className = "parametro";
  fila.innerHTML = `
    <td><input class="label" type="text" value="${label}" /></td>
    <td><input class="coef" type="number" step="0.01" value="${coef}" /></td>
    <td>
      <button type="button" class="move-btn" onclick="moverFila(this, 'arriba')">↑</button>
      <button type="button" class="move-btn" onclick="moverFila(this, 'abajo')">↓</button>
      <button type="button" class="delete-btn" onclick="eliminarFila(this)">X</button>
    </td>
  `;
  contenedor.appendChild(fila);
}

function guardarParametrosServidor() {
  const filas = document.querySelectorAll(".parametro");
  const formas_pago = [];
  filas.forEach((fila) => {
    const label = fila.querySelector(".label").value.trim();
    const coef = fila.querySelector(".coef").value.trim();
    if (label && coef !== "") {
      formas_pago.push({ label, coef: parseFloat(coef) });
    }
  });
  const marketing_fee = parseFloat(document.getElementById("marketing").value);

  fetch("/guardar-parametros", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ formas_pago, marketing_fee })
  })
    .then(res => res.json())
    .then(data => alert("✅ " + data.mensaje))
    .catch(err => alert("❌ Error guardando parámetros"));
}

window.addEventListener("DOMContentLoaded", () => {
  fetch("/obtener-parametros")
    .then(res => res.json())
    .then(data => {
      document.getElementById("marketing").value = data.marketing_fee || 0;
      const tbody = document.querySelector("#tabla-medios tbody");
      tbody.innerHTML = "";
      (data.formas_pago || []).forEach(p => agregarFila(p.label, p.coef));
    });

  document.getElementById("cotizarForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const codigos = document.getElementById("codigos").value.split(",").map(c => c.trim()).filter(c => c);
    const cliente = document.getElementById("cliente").value.trim() || "Kitchen Tools";
    const formasPago = {};
    document.querySelectorAll(".parametro").forEach((row) => {
      const label = row.querySelector(".label").value.trim();
      const coef = row.querySelector(".coef").value.trim();
      if (label && coef !== "") {
        formasPago[label] = { label, coef: parseFloat(coef) };
      }
    });
    const marketingFee = parseFloat(document.getElementById("marketing").value);
    const vencimiento = document.getElementById("vencimiento").value;

    const estado = document.getElementById("estadoCotizacion");
    const btnCotizar = document.getElementById("btnCotizar");
    estado.style.color = "#0d3a5e";
    estado.textContent = "⏳ Generando cotización...";
    btnCotizar.disabled = true;

    fetch("/cotizar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ codigos, cliente, vencimiento, formas_pago: formasPago, marketing_fee: marketingFee })
    })
      .then(res => {
        if (!res.ok) throw new Error("Error en la respuesta del servidor");
        return res.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "cotizacion_kitchen_tools.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        estado.style.color = "green";
        estado.textContent = "✅ Cotización generada con éxito.";
      })
      .catch(err => {
        console.error("❌ Error:", err);
        estado.style.color = "red";
        estado.textContent = "❌ Ocurrió un error al generar la cotización.";
      })
      .finally(() => {
        btnCotizar.disabled = false;
      });
  });
});
</script>
</body>
</html>